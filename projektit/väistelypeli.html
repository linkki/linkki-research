<!DOCTYPE html>
<html lang="fi">
<head>
	<meta charset="utf-8">
	<title>Jäsäkurssi - Väistelypeli</title>
	<link href="../pohja/pohja.css" rel="stylesheet" type="text/css">
		
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.6/ace.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.6/ext-language_tools.js"></script>
	<script src="../pohja/pohja.js"></script>
</head>
	<body>

	<div class="header">
	<nav>
			Jäsää lapsille
			· <a href="../osa1/osa1.html">Osa 1</a>
			· <a href="../osa2/osa2.html">Osa 2</a>
			· <a href="../osa3/osa3.html">Osa 3</a>
			· <a href="../osa4/osa4.html">Osa 4</a>
			· <a href="../osa5/osa5.html">Osa 5</a>
			· <a href="../projektit/projektit.html">Projektit</a>
	</nav>
	</div>

	<div class="content">

<h1>Väistelypeli</h1>

<canvas width = 800
        height = 600
        id = kangas
        style = background-color:beige;></canvas>
<script>

// Apufunktio etäisyyden laskemiseen
function etäisyys(hahmo1, hahmo2) {
	const dx = hahmo1.X - hahmo2.X
	const dy = hahmo1.Y - hahmo2.Y
	return Math.sqrt(dx*dx + dy*dy)
}

// Apufunktio siirtämiseen
function siirräKohti(hahmo1, hahmo2, nopeus) {
	const dx = hahmo2.X - hahmo1.X
	const dy = hahmo2.Y - hahmo1.Y
	const e = etäisyys(hahmo2, hahmo1)
	
	hahmo1.X += dx/e*nopeus
	hahmo1.Y += dy/e*nopeus
}

const piirtäjä = kangas.getContext("2d")

// Määritellään hahmot
const hiiri = {
	X: 0,
	Y: 0,
}
const pelaaja = {
	X: 100,
	Y: 100,
	pisteet: 0,
}
const viholliset = []

// Pidetään hiiren koordinaatit ajan tasalla
kangas.onmousemove = event => {
	hiiri.X = event.offsetX
	hiiri.Y = event.offsetY
}

function piirrä() {
	// Tyhjennetään ruutu
	piirtäjä.clearRect(0, 0, 800, 600)

	// Piirretään pisteet
	piirtäjä.fillStyle = "black"
	piirtäjä.fillText("Pisteet: " + pelaaja.pisteet, 10, 20)
	
	// Piirretään pelaajahahmo
	piirtäjä.fillStyle = "blue"
	piirtäjä.fillRect(pelaaja.X-50, pelaaja.Y-50, 100, 100)
	
	// Käydään läpi vihollishahmot
	for (const vihollinen of viholliset) {
		// Piirretään vihollishahmo
		piirtäjä.fillStyle = "red"
		piirtäjä.fillRect(vihollinen.X-50, vihollinen.Y-50, 100, 100)
	}
	
	// Pyydetään selainta piirtämään samat asiat kohta uudestaan
	requestAnimationFrame(piirrä)
}

// Pyydetään selainta piirtämään asiat ensimmäisen kerran
requestAnimationFrame(piirrä)

// Liikutetaan hahmoa ja vihollisia (ikuisessa silmukassa)
setInterval(() => {
	siirräKohti(pelaaja, hiiri, 3)
	
	// Käydään läpi viholliset
	for (const vihollinen of viholliset) {
		// Liikutetaan vihollista
		siirräKohti(vihollinen, pelaaja, 0.5)
		vihollinen.X -= 2

		// Tarkistetaan osuma pelaajaan
		if (etäisyys(pelaaja, vihollinen) < 100) {
			pelaaja.pisteet = 0
			pelaaja.X = 100
			pelaaja.Y = 100
			viholliset.splice(0, viholliset.length)
		}

		// Tarkistetaan osuma reunaan ja siirretään tarvittaessa takaisin alkuun
		if (vihollinen.X < -100) {
			vihollinen.X = 900
		}
	}
}, 10)

// Luodaan uusi vihollinen viiden sekunnin välein ja kasvatetaan samalla pisteitä
setInterval(() => {
	pelaaja.pisteet += 1
	viholliset.push({
		X: 900,
		Y: Math.random()*600,
	})
}, 5000)
</script>

<h2>Ohjeet</h2>

<h3>Alkuvalmistelut</h3>

<p class=task>Kopioi aloituspohja (kankaan kokoa ja väriä voi muuttaa halutessaan:</p>
<script>codeExample(`<!doctype HTML>

<canvas width = 800
        height = 600
        style = background-color:beige;></canvas>

<script>

${closeScript}`, "html");</script>

<p class=task>Käytämme tehtävässä seuraavia funktioita kahden hahmon etäisyyden laskemiseen ja hahmon liikuttamiseen. Kopioi ne <code>&lt;script&gt;</code>-tägien väliin.</p>
<script>codeExample(`// Apufunktio etäisyyden laskemiseen
function etäisyys(hahmo1, hahmo2) {
	const dx = hahmo1.X - hahmo2.X
	const dy = hahmo1.Y - hahmo2.Y
	return Math.sqrt(dx*dx + dy*dy)
}

// Apufunktio siirtämiseen
function siirräKohti(hahmo1, hahmo2, nopeus) {
	const dx = hahmo2.X - hahmo1.X
	const dy = hahmo2.Y - hahmo1.Y
	const e = etäisyys(hahmo2, hahmo1)
	
	hahmo1.X += dx/e*nopeus
	hahmo1.Y += dy/e*nopeus
}
`, "javascript");</script>

<p class=task>Määrittele piirtäjä-muuttuja piirtämistä varten:</p>
<script>codeExample(`const piirtäjä = kangas.getContext("2d") `, "javascript");</script>

<h3>Hahmojen muuttujat</h3>

<p>Muistutuksena hahmo-olion ja sen sisältämät muuttujat luodaan näin:</p>

<script>codeExample(`const pelaaja = {
	X: 100,
	Y: 100,
	pisteet: 0,
}
`, "javascript");</script>

<p>
	<span class=task>Luo <code>pelaaja</code>, jolla on muuttujat <code>X</code>, <code>Y</code> ja <code>pisteet</code>.</span>
	<span class=task>Lisäksi luo <code>hiiri</code>, joilla on vain <code>X</code> ja <code>Y</code>.</span>
	Voit asettaa hahmojen X- ja Y-koordinaatit alussa miten haluat.
</p>

<p>
	Hiiri-hahmon tarkoitus on olla siinä, missä hiiri on.
	JavaScriptissä emme voi selvittää milloin vain, missä hiiri on, vaan saamme tietää hiiren sijainnin vain, kun se liikkuu.
	Siirtämällä hiiri-hahmon kursorin päälle sen liikkuessa tiedämme aina, missä hiiri on.
	<span class=task>Käytä seuraavaa koodia:</span>
</p>

<script>codeExample(`// Pidetään hiiren koordinaatit ajan tasalla
kangas.onmousemove = event => {
	hiiri.X = event.offsetX
	hiiri.Y = event.offsetY
}
`, "javascript");</script>

<h3>Piirtosilmukka</h3>

<p class=task>Tee <code>piirrä</code>-funktiosta piirtosilmukka käyttäen <code>requestAnimationFrame</code>-funktiota:</p>

<script>codeExample(`function piirrä() {
	// Tyhjennetään ruutu
	piirtäjä.clearRect(0, 0, 800, 600)
	
	/* Piirretään hahmot tässä */
	
	// Pyydetään selainta piirtämään samat asiat kohta uudestaan
	requestAnimationFrame(piirrä)
}

// Pyydetään selainta piirtämään asiat ensimmäisen kerran
requestAnimationFrame(piirrä)
`, "javascript");</script>

<p class=task>
	Piirrä funktion sisällä pelaaja.
	Pelaajan koordinaatit ovat <code>pelaaja.X</code> ja <code>pelaaja.Y</code>.
	Voit piirtää joko neliön <code>fillRect</code>-komennolla tai kuvan <code>drawImage</code>-komennolla.
</p>

<p>
	Hiiren kohdalle ei tarvitse piirtää mitään, näkyyhän siinä jo käyttöjärjestelmän oma kursori, mutta siihen voi halutessaan piirtää oman kuvan.
</p>

<p class=task>
	Piirrä myös teksti <code>"Pisteet " + pelaaja.pisteet</code> näkymän yläreunaan. 
</p>

<p>
	Kokeile nyt, toimiiko pelaajan piirtäminen. Pisteiden kohdalla pitäisi lukea tietysti 0.
</p>

<h3>Pelaajan liikuttaminen</h3>

<p class=task>Tee <code>setInterval</code>-silmukka hahmojen liikuttamista varten:</p>

<script>codeExample(`setInterval(() => {
	
	/* Tähän tulee liikuttamisen koodi */
	
})
`, "javascript");</script>

<p class=task>
	Lisää komento hahmon liikuttamista varten.
	Hahmoja liikutetaan alussa luodulla <code>siirräKohti</code>-funktiolla.
	Aluksi meidän tarvitsee vain siirtää pelaajaa kohti hiirtä: <code>siirräKohti(pelaaja, hiiri, 1)</code>.
	Lopun <code>1</code> kertoo, millä nopeudella pelaaja liikkuu, ja voit muuttaa sitä halutessasi.
</p>

<p>
	Kokeile tässä vaiheessa, toimiiko peli ja hahmon liikuttaminen.
</p>

</div>
